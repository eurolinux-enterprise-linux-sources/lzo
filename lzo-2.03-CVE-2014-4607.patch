diff --git a/minilzo/minilzo.c b/minilzo/minilzo.c
index 6a62b31..62fdb32 100644
--- a/minilzo/minilzo.c
+++ b/minilzo/minilzo.c
@@ -3136,6 +3136,8 @@ DO_COMPRESS      ( const lzo_bytep in , lzo_uint  in_len,
 #undef TEST_LBO
 #undef NEED_IP
 #undef NEED_OP
+#undef TEST_IV
+#undef TEST_OV
 #undef HAVE_TEST_IP
 #undef HAVE_TEST_OP
 #undef HAVE_NEED_IP
@@ -3150,6 +3152,7 @@ DO_COMPRESS      ( const lzo_bytep in , lzo_uint  in_len,
 #  if (LZO_TEST_OVERRUN_INPUT >= 2)
 #    define NEED_IP(x) \
             if ((lzo_uint)(ip_end - ip) < (lzo_uint)(x))  goto input_overrun
+#    define TEST_IV(x)          if ((x) > (lzo_uint)0 - (511)) goto input_overrun
 #  endif
 #endif
 
@@ -3161,6 +3164,7 @@ DO_COMPRESS      ( const lzo_bytep in , lzo_uint  in_len,
 #    undef TEST_OP
 #    define NEED_OP(x) \
             if ((lzo_uint)(op_end - op) < (lzo_uint)(x))  goto output_overrun
+#    define TEST_OV(x)          if ((x) > (lzo_uint)0 - (511)) goto output_overrun
 #  endif
 #endif
 
@@ -3191,11 +3195,13 @@ DO_COMPRESS      ( const lzo_bytep in , lzo_uint  in_len,
 #  define HAVE_NEED_IP
 #else
 #  define NEED_IP(x)            ((void) 0)
+#  define TEST_IV(x)            ((void) 0)
 #endif
 #if defined(NEED_OP)
 #  define HAVE_NEED_OP
 #else
 #  define NEED_OP(x)            ((void) 0)
+#  define TEST_OV(x)            ((void) 0)
 #endif
 
 #if defined(HAVE_TEST_IP) || defined(HAVE_NEED_IP)
@@ -3286,6 +3292,7 @@ DO_DECOMPRESS  ( const lzo_bytep in , lzo_uint  in_len,
             {
                 t += 255;
                 ip++;
+                TEST_IV(t);
                 NEED_IP(1);
             }
             t += 15 + *ip++;
@@ -3417,6 +3424,7 @@ match:
                     {
                         t += 255;
                         ip++;
+                        TEST_OV(t);
                         NEED_IP(1);
                     }
                     t += 31 + *ip++;
@@ -3461,6 +3469,7 @@ match:
                     {
                         t += 255;
                         ip++;
+                        TEST_OV(t);
                         NEED_IP(1);
                     }
                     t += 7 + *ip++;
@@ -3634,6 +3643,8 @@ lookbehind_overrun:
 #undef TEST_LBO
 #undef NEED_IP
 #undef NEED_OP
+#undef TEST_IV
+#undef TEST_OV
 #undef HAVE_TEST_IP
 #undef HAVE_TEST_OP
 #undef HAVE_NEED_IP
@@ -3648,6 +3659,7 @@ lookbehind_overrun:
 #  if (LZO_TEST_OVERRUN_INPUT >= 2)
 #    define NEED_IP(x) \
             if ((lzo_uint)(ip_end - ip) < (lzo_uint)(x))  goto input_overrun
+#    define TEST_IV(x)          if ((x) > (lzo_uint)0 - (511)) goto input_overrun
 #  endif
 #endif
 
@@ -3659,6 +3671,7 @@ lookbehind_overrun:
 #    undef TEST_OP
 #    define NEED_OP(x) \
             if ((lzo_uint)(op_end - op) < (lzo_uint)(x))  goto output_overrun
+#    define TEST_OV(x)          if ((x) > (lzo_uint)0 - (511)) goto output_overrun
 #  endif
 #endif
 
@@ -3689,11 +3702,13 @@ lookbehind_overrun:
 #  define HAVE_NEED_IP
 #else
 #  define NEED_IP(x)            ((void) 0)
+#  define TEST_IV(x)            ((void) 0)
 #endif
 #if defined(NEED_OP)
 #  define HAVE_NEED_OP
 #else
 #  define NEED_OP(x)            ((void) 0)
+#  define TEST_OV(x)            ((void) 0)
 #endif
 
 #if defined(HAVE_TEST_IP) || defined(HAVE_NEED_IP)
@@ -3784,6 +3799,7 @@ DO_DECOMPRESS  ( const lzo_bytep in , lzo_uint  in_len,
             {
                 t += 255;
                 ip++;
+                TEST_IV(t);
                 NEED_IP(1);
             }
             t += 15 + *ip++;
@@ -3915,6 +3931,7 @@ match:
                     {
                         t += 255;
                         ip++;
+                        TEST_OV(t);
                         NEED_IP(1);
                     }
                     t += 31 + *ip++;
@@ -3959,6 +3976,7 @@ match:
                     {
                         t += 255;
                         ip++;
+                        TEST_OV(t);
                         NEED_IP(1);
                     }
                     t += 7 + *ip++;
diff --git a/src/lzo1_d.ch b/src/lzo1_d.ch
index c1dad39..c48edaf 100644
--- a/src/lzo1_d.ch
+++ b/src/lzo1_d.ch
@@ -73,6 +73,8 @@
 #undef TEST_LBO
 #undef NEED_IP
 #undef NEED_OP
+#undef TEST_IV
+#undef TEST_OV
 #undef HAVE_TEST_IP
 #undef HAVE_TEST_OP
 #undef HAVE_NEED_IP
@@ -88,6 +90,7 @@
 #  if (LZO_TEST_OVERRUN_INPUT >= 2)
 #    define NEED_IP(x) \
             if ((lzo_uint)(ip_end - ip) < (lzo_uint)(x))  goto input_overrun
+#    define TEST_IV(x)          if ((x) > (lzo_uint)0 - (511)) goto input_overrun
 #  endif
 #endif
 
@@ -99,6 +102,7 @@
 #    undef TEST_OP              /* don't need both of the tests here */
 #    define NEED_OP(x) \
             if ((lzo_uint)(op_end - op) < (lzo_uint)(x))  goto output_overrun
+#    define TEST_OV(x)          if ((x) > (lzo_uint)0 - (511)) goto output_overrun
 #  endif
 #endif
 
@@ -132,11 +136,13 @@
 #  define HAVE_NEED_IP
 #else
 #  define NEED_IP(x)            ((void) 0)
+#  define TEST_IV(x)            ((void) 0)
 #endif
 #if defined(NEED_OP)
 #  define HAVE_NEED_OP
 #else
 #  define NEED_OP(x)            ((void) 0)
+#  define TEST_OV(x)            ((void) 0)
 #endif
 
 
diff --git a/src/lzo1b_d.ch b/src/lzo1b_d.ch
index e38fad5..6f786d1 100644
--- a/src/lzo1b_d.ch
+++ b/src/lzo1b_d.ch
@@ -184,6 +184,7 @@ match:
                 {
                     t += 255;
                     ip++;
+                    TEST_OV(t);
                     NEED_IP(1);
                 }
                 t += (M4_MIN_LEN - M3_MIN_LEN) + *ip++;
diff --git a/src/lzo1f_d.ch b/src/lzo1f_d.ch
index 282ab35..6843af4 100644
--- a/src/lzo1f_d.ch
+++ b/src/lzo1f_d.ch
@@ -81,6 +81,7 @@ DO_DECOMPRESS  ( const lzo_bytep in , lzo_uint  in_len,
             {
                 t += 255;
                 ip++;
+                TEST_IV(t);
                 NEED_IP(1);
             }
             t += 31 + *ip++;
@@ -135,6 +136,7 @@ match:
                         {
                             t += 255;
                             ip++;
+                            TEST_OV(t);
                             NEED_IP(1);
                         }
                         t += 31 + *ip++;
diff --git a/src/lzo1x_d.ch b/src/lzo1x_d.ch
index d068866..41b45eb 100644
--- a/src/lzo1x_d.ch
+++ b/src/lzo1x_d.ch
@@ -128,6 +128,7 @@ DO_DECOMPRESS  ( const lzo_bytep in , lzo_uint  in_len,
             {
                 t += 255;
                 ip++;
+                TEST_IV(t);
                 NEED_IP(1);
             }
             t += 15 + *ip++;
@@ -264,6 +265,7 @@ match:
                     {
                         t += 255;
                         ip++;
+                        TEST_OV(t);
                         NEED_IP(1);
                     }
                     t += 31 + *ip++;
@@ -308,6 +310,7 @@ match:
                     {
                         t += 255;
                         ip++;
+                        TEST_OV(t);
                         NEED_IP(1);
                     }
                     t += 7 + *ip++;
diff --git a/src/lzo2a_d.ch b/src/lzo2a_d.ch
index 5822ac0..4c1af91 100644
--- a/src/lzo2a_d.ch
+++ b/src/lzo2a_d.ch
@@ -128,6 +128,7 @@ DO_DECOMPRESS    ( const lzo_bytep in , lzo_uint  in_len,
             {
                 t += 255;
                 ip++;
+                TEST_OV(t);
                 NEED_IP(1);
             }
             t += *ip++;
